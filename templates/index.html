<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Pre-Grader Control Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <main class="layout">
      <header>
        <h1>AI Pre-Grader Control Panel</h1>
      </header>

      <section class="controls">
        <div class="control-sliders">
          <div class="control-group">
            <label for="concurrency">Concurrent Runs: <span id="concurrency-value">{{ max_concurrent }}</span></label>
            <input
              type="range"
              id="concurrency"
              name="concurrency"
              min="1"
              max="10"
              value="{{ max_concurrent }}"
            />
          </div>
          <div class="control-group">
            <label for="nitpickiness">Nitpickiness: <span id="nitpickiness-value">{{ nitpickiness }}</span></label>
            <input
              type="range"
              id="nitpickiness"
              name="nitpickiness"
              min="1"
              max="5"
              value="{{ nitpickiness }}"
            />
          </div>
        </div>
        <div class="status" id="status">Status: {{ status }}</div>
      </section>

      {% set assignment_list = assignments or [] %}
      {% set has_assignments = assignment_list|length > 0 %}
      {% set new_mode = (assignment_title and assignment_title not in assignment_list) or (not has_assignments and not assignment_title) %}
      <section class="assignment-controls">
        <h2 class="assignment-controls__title">Assignments</h2>
        <div class="assignment-controls__form">
          <div class="form-group">
            <label for="assignment-selector">Assignment</label>
            <select id="assignment-selector" name="assignmentSelector">
              <option value="" disabled {% if not new_mode and not assignment_title %}selected{% endif %}>
                Select an assignment
              </option>
              {% for name in assignment_list %}
              <option value="{{ name }}" {% if name == assignment_title %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
              <option value="__new__" {% if new_mode %}selected{% endif %}>Create new assignment…</option>
            </select>
          </div>
          <div class="form-group" id="new-assignment-group" {% if not new_mode %}hidden{% endif %}>
            <label for="assignment-title">New Assignment Title</label>
            <input
              type="text"
              id="assignment-title"
              name="assignmentTitle"
              placeholder="Enter assignment title"
              value="{% if new_mode %}{{ assignment_title }}{% endif %}"
            />
          </div>
        </div>
      </section>

      <section class="notes">
        <label for="grading-notes">Grading Notes</label>
        <textarea
          id="grading-notes"
          name="grading-notes"
          rows="5"
          placeholder="Add context for the grader, such as key concepts or specific mistakes to watch for.">{{ grading_notes }}</textarea>
      </section>

      <section class="panels">
        <article class="panel" data-category="solutions">
          <h2>Solution</h2>
          <p class="panel-description">Drop a PDF or use the upload button.</p>
          <div class="drop-area" data-category="solutions">
            <p>Drop PDF here</p>
            <input type="file" accept="application/pdf" />
          </div>
          <div class="panel-actions">
            <button class="button" data-action="generate">Generate Solution</button>
            <button class="button secondary" data-action="wipe">Wipe Folder</button>
          </div>
          {% set file_info = authoritative_files.get('solutions', {'files': [], 'exists': False}) %}
          <div class="file-group">
            <h3>Files</h3>
            <ul class="file-list" data-files-category="solutions">
              {% if file_info.files %}
              {% for name in file_info.files %}
              <li>{{ name }}</li>
              {% endfor %}
              {% else %}
              <li class="empty">
                {% if file_info.exists %}
                No files available.
                {% else %}
                Folder not found.
                {% endif %}
              </li>
              {% endif %}
            </ul>
          </div>
        </article>

        <article class="panel" data-category="problems">
          <h2>Problems</h2>
          <p class="panel-description">Drop a PDF or use the upload button.</p>
          <div class="drop-area" data-category="problems">
            <p>Drop PDF here</p>
            <input type="file" accept="application/pdf" />
          </div>
          <div class="panel-actions">
            <button class="button secondary" data-action="wipe">Wipe Folder</button>
          </div>
          {% set file_info = authoritative_files.get('problems', {'files': [], 'exists': False}) %}
          <div class="file-group">
            <h3>Files</h3>
            <ul class="file-list" data-files-category="problems">
              {% if file_info.files %}
              {% for name in file_info.files %}
              <li>{{ name }}</li>
              {% endfor %}
              {% else %}
              <li class="empty">
                {% if file_info.exists %}
                No files available.
                {% else %}
                Folder not found.
                {% endif %}
              </li>
              {% endif %}
            </ul>
          </div>
        </article>

        <article class="panel" data-category="submissions">
          <h2>Student Submissions</h2>
          <p class="panel-description">
            Drop a single PDF or a folder of PDFs, or use the upload button.
          </p>
          <div class="drop-area" data-category="submissions">
            <p>Drop PDF or folder here</p>
            <input type="file" accept="application/pdf" webkitdirectory directory multiple />
          </div>
          <div class="panel-actions">
            <button class="button" data-action="grade">Grade Submission</button>
            <button class="button secondary" data-action="wipe">Wipe Folder</button>
          </div>
          {% set file_info = authoritative_files.get('submissions', {'files': [], 'exists': False}) %}
          <div class="file-group">
            <h3>Files</h3>
            <ul class="file-list" data-files-category="submissions">
              {% if file_info.files %}
              {% for name in file_info.files %}
              <li>{{ name }}</li>
              {% endfor %}
              {% else %}
              <li class="empty">
                {% if file_info.exists %}
                No files available.
                {% else %}
                Folder not found.
                {% endif %}
              </li>
              {% endif %}
            </ul>
          </div>
        </article>
      </section>
    </main>

    <div class="grading-modal" id="grading-modal" aria-hidden="true">
      <div class="grading-modal__backdrop"></div>
      <div
        class="grading-modal__dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="grading-modal-title"
      >
        <header class="grading-modal__header">
          <div class="grading-modal__heading">
            <h2 id="grading-modal-title">Grading submissions</h2>
            <p
              class="grading-modal__subtitle"
              data-role="assignment-label"
            >
              Tracking live progress…
            </p>
          </div>
          <div class="grading-progress">
            <div
              class="grading-progress__wheel"
              data-role="progress-wheel"
              aria-hidden="true"
            ></div>
            <div class="grading-progress__label">
              <span data-role="progress-count">0</span>/<span
                data-role="progress-total"
                >0</span
              >
            </div>
          </div>
        </header>
        <section class="grading-modal__summary" aria-live="polite">
          <div class="summary-chip" data-role="chip-running">
            Running <span data-role="count-running">0</span>
          </div>
          <div class="summary-chip" data-role="chip-complete">
            Completed <span data-role="count-completed">0</span>
          </div>
          <div class="summary-chip" data-role="chip-flagged">
            Needs review <span data-role="count-flagged">0</span>
          </div>
          <div class="summary-chip" data-role="chip-issues">
            Problems <span data-role="count-issues">0</span>
          </div>
        </section>
        <section
          class="grading-modal__timeline"
          data-role="timeline"
          aria-live="polite"
        ></section>
        <footer class="grading-modal__footer">
          <div class="grading-modal__report" data-role="report-message" hidden>
            <p>
              Report saved to <code data-role="report-path"></code>.
            </p>
          </div>
          <button class="button secondary" type="button" data-role="close-modal" disabled>
            Close
          </button>
        </footer>
      </div>
    </div>

    <script src="{{ url_for('static', filename='app.js') }}" defer></script>
  </body>
</html>
